---

- name: Add user
  user: name={{ adduser_user_name }} password="{{ adduser_password }}" comment="{{ adduser_user_comments }}" shell=/bin/bash
  when: ansible_distribution != 'OpenBSD'

- name: Add user - OpenBSD
  user: name={{ adduser_user_name }} shell=/bin/ksh
  when: ansible_distribution == 'OpenBSD'

- name: Add authorized keys for {{ adduser_user_name }} user
  authorized_key: 
    "user='{{ adduser_user_name }}' key='{{ item }}'"
  with_file: "{{ adduser_public_keys }}"
  when: adduser_public_keys is defined and adduser_sshkey_options is not defined
- name: Add authorized keys for {{ adduser_user_name }} user - key_options
  authorized_key: 
    user: "{{ adduser_user_name }}"
    key: "{{ item }}"
    key_options: "{{ adduser_sshkey_options }}"
  with_file: "{{ adduser_public_keys }}"
  when: adduser_public_keys is defined and adduser_sshkey_options is defined


- name: SSH authorized_keys {{ adduser_user_name }}
  file:
    dest=/home/{{ adduser_user_name }}/.ssh owner={{ adduser_user_name }} mode=700 state=directory

- stat: path=/etc/sudoers
  register: sudoers
- name: Add user to sudoers
  lineinfile: "dest=/etc/sudoers regexp='^{{ adduser_user_name }} ALL' line='{{ adduser_user_name }} ALL=(ALL) NOPASSWD: ALL' state=present"
  when: adduser_sudoroot is defined and adduser_sudoroot and sudoers.stat.exists

